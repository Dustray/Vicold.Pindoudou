@page "/"
@using Microsoft.AspNetCore.Components.Forms
@using System.IO
@using System
@using Vicold.Pindoudou.Entities
@using Vicold.Pindoudou.Utils
@using Microsoft.Maui.Storage
@inject NavigationManager NavigationManager
@inject Microsoft.JSInterop.IJSRuntime JSRuntime

<h1>拼豆图纸设计工具</h1>

<div class="container">
    <div class="row">
        <!-- 左侧控制面板 -->
        <div class="col-md-4">
            <h3>设置</h3>

            <!-- 图片上传 -->
            <div class="mb-3">
                <label class="form-label">上传图片</label>
                <InputFile OnChange="LoadImage" accept=".jpg,.jpeg,.png,.gif" />
            </div>

            <!-- 像素大小设置 -->
            <div class="mb-3">
                <label class="form-label">像素宽度</label>
                <input type="number" class="form-control" @bind="PixelWidth" min="1" max="100" />
            </div>
            <div class="mb-3">
                <label class="form-label">像素高度</label>
                <input type="number" class="form-control" @bind="PixelHeight" min="1" max="100" />
            </div>

            <!-- 调色板选择 -->
            <div class="mb-3">
                <label class="form-label">调色板</label>
                <select class="form-control" @bind="SelectedPalette">
                    @foreach (var palette in AllPalettes)
                    {
                        <option value="@palette.Name">@palette.Name (@(palette.Type == "System" ? "标准" : "自定义"))</option>
                    }
                </select>
            </div>

            <!-- 生成按钮 -->
            <button class="btn btn-primary" @onclick="GeneratePixelArt" disabled="@IsGenerating">
                @if (IsGenerating)
                {
                    <span>生成中...</span>
                }
                else
                {
                    <span>生成像素图</span>
                }
            </button>

            <!-- 错误消息 -->
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger mt-2">@ErrorMessage</div>
            }

            <!-- 成功消息 -->
            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="alert alert-success mt-2">@SuccessMessage</div>
            }
        </div>

        <!-- 右侧预览区域 -->
        <div class="col-md-8">
            <h3>预览</h3>
            <div class="preview-container">
                @if (PixelArtData != null)
                {
                    <div class="pixel-art" style="display: inline-block;">
                        @for (int y = 0; y < PixelHeight; y++)
                        {
                            <div class="pixel-row">
                                @for (int x = 0; x < PixelWidth; x++)
                                {
                                    var index = y * PixelWidth + x;
                                    if (index < PixelArtData.Length)
                                    {
                                        var color = PixelArtData[index];
                                        <div class="pixel" style="background-color: @color;"></div>
                                    }
                                }
                            </div>
                        }
                    </div>
                }
                else if (OriginalImageUrl != null)
                {
                    <img src="@OriginalImageUrl" class="original-image" alt="原始图片" />
                }
                else
                {
                    <div class="empty-preview">请上传图片并设置参数</div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .preview-container {
        border: 1px solid #ddd;
        padding: 20px;
        min-height: 400px;
        text-align: center;
        background-color: #f9f9f9;
    }

    .pixel-art {
        margin: 0 auto;
    }

    .pixel-row {
        display: flex;
    }

    .pixel {
        width: 20px;
        height: 20px;
        border: 1px solid #eee;
    }

    .original-image {
        max-width: 100%;
        max-height: 400px;
    }

    .empty-preview {
        color: #999;
        padding: 100px 0;
    }

    .palette-color {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .form-control-color {
        width: 60px;
        height: 40px;
        padding: 0;
    }
</style>

@code {
    private int PixelWidth { get; set; } = 50;
    private int PixelHeight { get; set; } = 50;
    private string SelectedPalette { get; set; } = "Mard";
    private string? OriginalImageUrl { get; set; }
    private string[]? PixelArtData { get; set; }
    private IBrowserFile? uploadedFile;
    private Vicold.Pindoudou.Entities.Color[]? OriginalPixels { get; set; }
    private int OriginalWidth { get; set; }
    private int OriginalHeight { get; set; }
    private List<string> PaletteColors { get; set; } = new List<string>();
    private List<PaletteInfo> AllPalettes { get; set; } = new List<PaletteInfo>();
    private bool IsGenerating { get; set; } = false;
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }

    private class PaletteInfo
    {
        public string Name { get; set; }
        public string Path { get; set; }
        public string Type { get; set; } // "System" or "User"
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadPalette();
        LoadAllPalettes();
    }

    private void LoadAllPalettes()
    {
        AllPalettes.Clear();

        // 使用跨平台兼容的应用数据目录
        string appDataDir = FileSystem.AppDataDirectory;
        
        // 加载 Palettes 文件夹中的系统调色板
        string systemPalettesPath = Path.Combine(appDataDir, "Data", "Palettes");
        if (Directory.Exists(systemPalettesPath))
        {
            var systemPalettes = Directory.GetFiles(systemPalettesPath, "*.txt")
                .Select(file => new PaletteInfo
                {
                    Name = Path.GetFileNameWithoutExtension(file),
                    Path = file,
                    Type = "System"
                });

            AllPalettes.AddRange(systemPalettes);
        }
        else
        {
            // 如果AppData目录中不存在，尝试使用应用程序基础目录（用于Windows调试）
            string baseDir = AppDomain.CurrentDomain.BaseDirectory;
            systemPalettesPath = Path.Combine(baseDir, "Data", "Palettes");
            if (Directory.Exists(systemPalettesPath))
            {
                var systemPalettes = Directory.GetFiles(systemPalettesPath, "*.txt")
                    .Select(file => new PaletteInfo
                    {
                        Name = Path.GetFileNameWithoutExtension(file),
                        Path = file,
                        Type = "System"
                    });

                AllPalettes.AddRange(systemPalettes);
            }
        }

        // 加载 UserPalettes 文件夹中的用户调色板
        string userPalettesPath = Path.Combine(appDataDir, "Data", "UserPalettes");
        if (Directory.Exists(userPalettesPath))
        {
            var userPalettes = Directory.GetFiles(userPalettesPath, "*.txt")
                .Select(file => new PaletteInfo
                {
                    Name = Path.GetFileNameWithoutExtension(file),
                    Path = file,
                    Type = "User"
                });

            AllPalettes.AddRange(userPalettes);
        }
        else
        {
            // 如果AppData目录中不存在，尝试使用应用程序基础目录（用于Windows调试）
            string baseDir = AppDomain.CurrentDomain.BaseDirectory;
            userPalettesPath = Path.Combine(baseDir, "Data", "UserPalettes");
            if (Directory.Exists(userPalettesPath))
            {
                var userPalettes = Directory.GetFiles(userPalettesPath, "*.txt")
                    .Select(file => new PaletteInfo
                    {
                        Name = Path.GetFileNameWithoutExtension(file),
                        Path = file,
                        Type = "User"
                    });

                AllPalettes.AddRange(userPalettes);
            }
        }
    }

    private Dictionary<string, string> LoadPaletteFromFile(string palettePath)
    {
        var palette = new Dictionary<string, string>();
        if (File.Exists(palettePath))
        {
            var lines = File.ReadAllLines(palettePath);
            for (int i = 0; i < lines.Length; i++)
            {
                var parts = lines[i].Split('\t');
                if (parts.Length >= 2)
                {
                    var color = parts[1].ToUpper();
                    palette[parts[0]] = color;
                }
            }
        }
        else
        {
            // 如果文件不存在，返回默认颜色
            var defaultColors = new List<string> { "#FFFFFF", "#000000", "#FF0000", "#00FF00", "#0000FF" };
            for (int i = 0; i < defaultColors.Count; i++)
            {
                var color = defaultColors[i];
                var code = GetPaletteCode(i);
                palette[code] = color; // code为key，color为value
            }
        }
        return palette;
    }

    private async Task LoadPalette()
    {
        // 使用跨平台兼容的应用数据目录
        string appDataDir = FileSystem.AppDataDirectory;
        var palettePath = Path.Combine(appDataDir, "Data", "Palettes", "Mard.txt");
        
        if (!File.Exists(palettePath))
        {
            // 尝试使用应用程序基础目录（用于Windows调试）
            string baseDir = AppDomain.CurrentDomain.BaseDirectory;
            palettePath = Path.Combine(baseDir, "Data", "Palettes", "Mard.txt");
        }

        if (!File.Exists(palettePath))
        {
            // 尝试使用当前工作目录
            palettePath = Path.Combine(Directory.GetCurrentDirectory(), "Data", "Palettes", "Mard.txt");
        }

        if (File.Exists(palettePath))
        {
            var lines = await File.ReadAllLinesAsync(palettePath);
            PaletteColors = lines.Select(line => line.Split('\t')[1]).ToList();
        }
        else
        {
            // 如果文件不存在，使用默认颜色
            PaletteColors = new List<string> { "#FFFFFF", "#000000", "#FF0000", "#00FF00", "#0000FF" };
        }
    }

    private async Task LoadImage(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        var stream = uploadedFile.OpenReadStream();
        var memoryStream = new MemoryStream();
        await stream.CopyToAsync(memoryStream);
        memoryStream.Position = 0;

        var bytes = memoryStream.ToArray();
        OriginalImageUrl = $"data:{uploadedFile.ContentType};base64,{Convert.ToBase64String(bytes)}";

        // 使用 Microsoft.Maui.Graphics 获取真实的图像尺寸
        try
        {
            using var imageStream = new MemoryStream(bytes);
            using var image = Microsoft.Maui.Graphics.Platform.PlatformImage.FromStream(imageStream);
            //get pixel data
            OriginalPixels = ImageUtil.GetPixelData(image);
            OriginalWidth = (int)image.Width;
            OriginalHeight = (int)image.Height;
        }
        catch (Exception ex)
        {
            return;
        }
    }

    private async Task GeneratePixelArt()
    {

        ErrorMessage = null;
        SuccessMessage = null;

        if (OriginalPixels is null)
        {
            ErrorMessage = $"生成失败：原始图像出错";
            return;
        }

        if (uploadedFile == null)
        {
            ErrorMessage = "请先上传图片";
            return;
        }

        if (PixelWidth <= 0 || PixelHeight <= 0)
        {
            ErrorMessage = "请设置有效的像素大小";
            return;
        }

        Dictionary<string, string> currentPalette = new Dictionary<string, string>();// code, color

        // 查找选中的调色板
        var selectedPaletteInfo = AllPalettes.FirstOrDefault(p => p.Name == SelectedPalette);
        if (selectedPaletteInfo != null)
        {
            // 加载对应的调色板文件
            var loadedPalette = LoadPaletteFromFile(selectedPaletteInfo.Path);
            currentPalette = loadedPalette;

        }
        else
        {
            // 默认使用 Mard 调色板
            // for (int i = 0; i < PaletteColors.Count; i++)
            // {
            //     var color = PaletteColors[i];
            //     var code = GetPaletteCode(i);
            //     currentPalette[code] = color;
            // }
        }

        if (currentPalette.Count == 0)
        {
            ErrorMessage = "当前调色板中没有颜色";
            return;
        }

        IsGenerating = true;

        try
        {

            // 创建调色板实体
            var palette = new PaletteEntity();

            // 填充调色板实体
            int index = 0;
            foreach (var kvp in currentPalette)
            {
                var colorHex = kvp.Value;
                var color = Vicold.Pindoudou.Entities.Color.FromHex(colorHex);
                palette.AddColor($"Color{index}", color);
                index++;
            }

            // 使用真实的图像数据
            var originalWidth = OriginalWidth > 0 ? OriginalWidth : PixelWidth * 10; // 使用真实宽度或默认值
            var originalHeight = OriginalHeight > 0 ? OriginalHeight : PixelHeight * 10; // 使用真实高度或默认值
            var originalPixels = OriginalPixels; // 使用真实像素数据或模拟数据

            // 使用 PixelArtGenerator 生成像素图
            var pixelData = PixelArtGenerator.GeneratePixelArt(originalWidth, originalHeight, PixelWidth, PixelHeight, originalPixels, palette);

            PixelArtData = pixelData;
            SuccessMessage = "像素图生成成功";

            // 简单的字符串编码，实际应用中应该使用 JSON 序列化
            var pixelDataString = string.Join(",", PixelArtData);
            var paletteColorsString = string.Join(",", currentPalette.Values); // 使用Values获取颜色值
            
            // 存储到 sessionStorage
            var navigationData = new {
                Width = PixelWidth,
                Height = PixelHeight,
                Palette = SelectedPalette,
                PixelData = pixelDataString,
                PaletteColors = paletteColorsString,
                CurrentPalette = currentPalette
            };
            var jsonData = System.Text.Json.JsonSerializer.Serialize(navigationData);
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "navigationData", jsonData);
            
            // 导航到 Counter 页面
            NavigationManager.NavigateTo("/counter");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"生成失败：{ex.Message}";
        }
        finally
        {
            IsGenerating = false;
        }
    }

    private string GetPaletteCode(int index)
    {
        // 生成类似 A1、A2、B1、B2 的调色板代码
        char letter = (char)('A' + (index / 10));
        int number = (index % 10) + 1;
        return $"{letter}{number}";
    }
}