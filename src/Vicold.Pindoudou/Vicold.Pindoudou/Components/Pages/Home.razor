@page "/"
@using Microsoft.AspNetCore.Components.Forms
@using System.IO
@using System
@using Vicold.Pindoudou.Entities
@using Vicold.Pindoudou.Utils
@using Microsoft.Maui.Storage
@inject NavigationManager NavigationManager
@inject Microsoft.JSInterop.IJSRuntime JSRuntime

<div class="app-container" >
    <header class="app-header">
        <h1>æ‹¼è±†å›¾çº¸è®¾è®¡å·¥å…·</h1>
        <p class="app-subtitle">å°†å›¾ç‰‡è½¬æ¢ä¸ºç²¾ç¾çš„æ‹¼è±†åƒç´ è‰ºæœ¯</p>
    </header>

    <div class="container mt-4">
        <div class="row">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="col-md-4">
                <div class="control-panel card shadow-sm">
                    <div class="card-header">
                        <h3>è®¾ç½®</h3>
                    </div>
                    <div class="card-body">
                        <!-- å›¾ç‰‡ä¸Šä¼  -->
                        <div class="mb-4">
                            <label class="form-label">ä¸Šä¼ å›¾ç‰‡</label>
                            <div class="custom-file-upload">
                                <InputFile OnChange="LoadImage" accept=".jpg,.jpeg,.png,.gif" class="form-control-file" />
                                <span class="file-upload-text">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</span>
                            </div>
                        </div>

                        <!-- åƒç´ å¤§å°è®¾ç½® -->
                        <div class="mb-4">
                            <label class="form-label">åƒç´ å¤§å°</label>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="widthSlider" class="form-label">å®½åº¦: @PixelWidth</label>
                                    <input type="range" id="widthSlider" class="form-range" @bind="PixelWidth" @bind:event="oninput" min="10" max="200" step="1" />
                                </div>
                                <div class="col-12">
                                    <label for="heightSlider" class="form-label">é«˜åº¦: @PixelHeight</label>
                                    <input type="range" id="heightSlider" class="form-range" @bind="PixelHeight" @bind:event="oninput" min="10" max="200" step="1" />
                                </div>
                                <div class="col-12 d-flex items-center justify-content-center mt-2">
                                    <button type="button" class="btn btn-sm" @onclick="ToggleLockAspectRatio" title="@(IsAspectRatioLocked ? "è§£é”å®½é«˜æ¯”ä¾‹" : "é”å®šå®½é«˜æ¯”ä¾‹")">
                                        @(IsAspectRatioLocked ? "ğŸ”’" : "ğŸ”“")
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- è°ƒè‰²æ¿é€‰æ‹© -->
                        <div class="mb-4">
                            <label class="form-label">è°ƒè‰²æ¿</label>
                            <select class="form-control" @bind="SelectedPalette">
                                @foreach (var palette in AllPalettes)
                                {
                                    <option value="@palette.Name">@palette.Name (@(palette.Type == "System" ? "æ ‡å‡†" : "è‡ªå®šä¹‰"))</option>
                                }
                            </select>
                        </div>

                        <!-- ç”ŸæˆæŒ‰é’® -->
                        <button class="btn btn-primary w-100 generate-btn" @onclick="GeneratePixelArt" disabled="@IsGenerating">
                            @if (IsGenerating)
                            {
                                <span>ç”Ÿæˆä¸­...</span>
                            }
                            else
                            {
                                <span>ç”Ÿæˆåƒç´ å›¾</span>
                            }
                        </button>

                        <!-- é”™è¯¯æ¶ˆæ¯ -->
                        @if (!string.IsNullOrEmpty(ErrorMessage))
                        {
                            <div class="alert alert-danger mt-3">@ErrorMessage</div>
                        }

                        <!-- æˆåŠŸæ¶ˆæ¯ -->
                        @if (!string.IsNullOrEmpty(SuccessMessage))
                        {
                            <div class="alert alert-success mt-3">@SuccessMessage</div>
                        }
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢„è§ˆåŒºåŸŸ -->
            <div class="col-md-8">
                <div class="preview-panel card shadow-sm">
                    <div class="card-header">
                        <h3>é¢„è§ˆ</h3>
                    </div>
                    <div class="card-body">
                        <div class="preview-container">
                            @if (PixelArtData != null)
                            {
                                <div class="pixel-art" style="display: inline-block;">
                                    @for (int y = 0; y < PixelHeight; y++)
                                    {
                                        <div class="pixel-row">
                                            @for (int x = 0; x < PixelWidth; x++)
                                            {
                                                var index = y * PixelWidth + x;
                                                if (index < PixelArtData.Length)
                                                {
                                                    var color = PixelArtData[index];
                                                    <div class="pixel" style="background-color: @color;"></div>
                                                }
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            else if (OriginalImageUrl != null)
                            {
                                <img src="@OriginalImageUrl" class="original-image" alt="åŸå§‹å›¾ç‰‡" />
                            }
                            else
                            {
                                <div class="empty-preview">
                                    <div class="empty-icon">ğŸ“·</div>
                                    <div class="empty-text">è¯·ä¸Šä¼ å›¾ç‰‡å¹¶è®¾ç½®å‚æ•°</div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* é¢„è§ˆå®¹å™¨æ ·å¼ */
    .preview-container {
        border: 2px dashed #dee2e6;
        padding: 30px;
        min-height: 450px;
        text-align: center;
        background-color: #ffffff;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .preview-container:hover {
        border-color: #667eea;
        background-color: #f8f9ff;
    }
</style>

@code {
    private int _pixelWidth = 50;
    private int _pixelHeight = 50;
    private bool IsAspectRatioLocked { get; set; } = false;
    private string SelectedPalette { get; set; } = "Mard";

    private int PixelWidth
    {
        get => _pixelWidth;
        set
        {
            _pixelWidth = value;
            if (IsAspectRatioLocked)
            {
                _pixelHeight = value;
            }
        }
    }

    private int PixelHeight
    {
        get => _pixelHeight;
        set
        {
            _pixelHeight = value;
            if (IsAspectRatioLocked)
            {
                _pixelWidth = value;
            }
        }
    }

    private void ToggleLockAspectRatio()
    {
        IsAspectRatioLocked = !IsAspectRatioLocked;
        if (IsAspectRatioLocked)
        {
            // é”å®šæ—¶ï¼Œå°†é«˜åº¦è®¾ç½®ä¸ºä¸å®½åº¦ç›¸åŒ
            _pixelHeight = _pixelWidth;
        }
    }
    private string? OriginalImageUrl { get; set; }
    private string[]? PixelArtData { get; set; }
    private IBrowserFile? uploadedFile;
    private Vicold.Pindoudou.Entities.Color[]? OriginalPixels { get; set; }
    private int OriginalWidth { get; set; }
    private int OriginalHeight { get; set; }
    private List<string> PaletteColors { get; set; } = new List<string>();
    private List<PaletteInfo> AllPalettes { get; set; } = new List<PaletteInfo>();
    private bool IsGenerating { get; set; } = false;
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }

    private class PaletteInfo
    {
        public string Name { get; set; }
        public string Path { get; set; }
        public string Type { get; set; } // "System" or "User"
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadPalette();
        LoadAllPalettes();
    }

    private void LoadAllPalettes()
    {
        AllPalettes.Clear();

        // ä½¿ç”¨è·¨å¹³å°å…¼å®¹çš„åº”ç”¨æ•°æ®ç›®å½•
        string appDataDir = FileSystem.AppDataDirectory;
        
        // åŠ è½½ Palettes æ–‡ä»¶å¤¹ä¸­çš„ç³»ç»Ÿè°ƒè‰²æ¿
        string systemPalettesPath = Path.Combine(appDataDir, "Data", "Palettes");
        if (Directory.Exists(systemPalettesPath))
        {
            var systemPalettes = Directory.GetFiles(systemPalettesPath, "*.txt")
                .Select(file => new PaletteInfo
                {
                    Name = Path.GetFileNameWithoutExtension(file),
                    Path = file,
                    Type = "System"
                });

            AllPalettes.AddRange(systemPalettes);
        }
        else
        {
            // å¦‚æœAppDataç›®å½•ä¸­ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨åº”ç”¨ç¨‹åºåŸºç¡€ç›®å½•ï¼ˆç”¨äºWindowsè°ƒè¯•ï¼‰
            string baseDir = AppDomain.CurrentDomain.BaseDirectory;
            systemPalettesPath = Path.Combine(baseDir, "Data", "Palettes");
            if (Directory.Exists(systemPalettesPath))
            {
                var systemPalettes = Directory.GetFiles(systemPalettesPath, "*.txt")
                    .Select(file => new PaletteInfo
                    {
                        Name = Path.GetFileNameWithoutExtension(file),
                        Path = file,
                        Type = "System"
                    });

                AllPalettes.AddRange(systemPalettes);
            }
        }

        // åŠ è½½ UserPalettes æ–‡ä»¶å¤¹ä¸­çš„ç”¨æˆ·è°ƒè‰²æ¿
        string userPalettesPath = Path.Combine(appDataDir, "Data", "UserPalettes");
        if (Directory.Exists(userPalettesPath))
        {
            var userPalettes = Directory.GetFiles(userPalettesPath, "*.txt")
                .Select(file => new PaletteInfo
                {
                    Name = Path.GetFileNameWithoutExtension(file),
                    Path = file,
                    Type = "User"
                });

            AllPalettes.AddRange(userPalettes);
        }
        else
        {
            // å¦‚æœAppDataç›®å½•ä¸­ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨åº”ç”¨ç¨‹åºåŸºç¡€ç›®å½•ï¼ˆç”¨äºWindowsè°ƒè¯•ï¼‰
            string baseDir = AppDomain.CurrentDomain.BaseDirectory;
            userPalettesPath = Path.Combine(baseDir, "Data", "UserPalettes");
            if (Directory.Exists(userPalettesPath))
            {
                var userPalettes = Directory.GetFiles(userPalettesPath, "*.txt")
                    .Select(file => new PaletteInfo
                    {
                        Name = Path.GetFileNameWithoutExtension(file),
                        Path = file,
                        Type = "User"
                    });

                AllPalettes.AddRange(userPalettes);
            }
        }
    }

    private Dictionary<string, string> LoadPaletteFromFile(string palettePath)
    {
        var palette = new Dictionary<string, string>();
        if (File.Exists(palettePath))
        {
            var lines = File.ReadAllLines(palettePath);
            for (int i = 0; i < lines.Length; i++)
            {
                var parts = lines[i].Split('\t');
                if (parts.Length >= 2)
                {
                    var color = parts[1].ToUpper();
                    palette[parts[0]] = color;
                }
            }
        }
        else
        {
            // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å›é»˜è®¤é¢œè‰²
            var defaultColors = new List<string> { "#FFFFFF", "#000000", "#FF0000", "#00FF00", "#0000FF" };
            for (int i = 0; i < defaultColors.Count; i++)
            {
                var color = defaultColors[i];
                var code = GetPaletteCode(i);
                palette[code] = color; // codeä¸ºkeyï¼Œcolorä¸ºvalue
            }
        }
        return palette;
    }

    private async Task LoadPalette()
    {
        // ä½¿ç”¨è·¨å¹³å°å…¼å®¹çš„åº”ç”¨æ•°æ®ç›®å½•
        string appDataDir = FileSystem.AppDataDirectory;
        var palettePath = Path.Combine(appDataDir, "Data", "Palettes", "Mard.txt");
        
        if (!File.Exists(palettePath))
        {
            // å°è¯•ä½¿ç”¨åº”ç”¨ç¨‹åºåŸºç¡€ç›®å½•ï¼ˆç”¨äºWindowsè°ƒè¯•ï¼‰
            string baseDir = AppDomain.CurrentDomain.BaseDirectory;
            palettePath = Path.Combine(baseDir, "Data", "Palettes", "Mard.txt");
        }

        if (!File.Exists(palettePath))
        {
            // å°è¯•ä½¿ç”¨å½“å‰å·¥ä½œç›®å½•
            palettePath = Path.Combine(Directory.GetCurrentDirectory(), "Data", "Palettes", "Mard.txt");
        }

        if (File.Exists(palettePath))
        {
            var lines = await File.ReadAllLinesAsync(palettePath);
            PaletteColors = lines.Select(line => line.Split('\t')[1]).ToList();
        }
        else
        {
            // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
            PaletteColors = new List<string> { "#FFFFFF", "#000000", "#FF0000", "#00FF00", "#0000FF" };
        }
    }

    private async Task LoadImage(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        var stream = uploadedFile.OpenReadStream();
        var memoryStream = new MemoryStream();
        await stream.CopyToAsync(memoryStream);
        memoryStream.Position = 0;

        var bytes = memoryStream.ToArray();
        OriginalImageUrl = $"data:{uploadedFile.ContentType};base64,{Convert.ToBase64String(bytes)}";

        // ä½¿ç”¨ Microsoft.Maui.Graphics è·å–çœŸå®çš„å›¾åƒå°ºå¯¸
        try
        {
            using var imageStream = new MemoryStream(bytes);
            using var image = Microsoft.Maui.Graphics.Platform.PlatformImage.FromStream(imageStream);
            //get pixel data
            OriginalPixels = ImageUtil.GetPixelData(image);
            OriginalWidth = (int)image.Width;
            OriginalHeight = (int)image.Height;
            
            // æ ¹æ®å›¾ç‰‡åŸå§‹æ¯”ä¾‹è®¡ç®—æ–°çš„åƒç´ å®½é«˜ï¼ŒçŸ­è¾¹ä¸º50åƒç´ 
            if (OriginalWidth > 0 && OriginalHeight > 0)
            {
                if (OriginalWidth <= OriginalHeight)
                {
                    // å®½åº¦æ˜¯çŸ­è¾¹
                    _pixelWidth = 50;
                    _pixelHeight = (int)(OriginalHeight * 50.0 / OriginalWidth);
                }
                else
                {
                    // é«˜åº¦æ˜¯çŸ­è¾¹
                    _pixelHeight = 50;
                    _pixelWidth = (int)(OriginalWidth * 50.0 / OriginalHeight);
                }
            }
        }
        catch (Exception ex)
        {
            return;
        }
    }

    private async Task GeneratePixelArt()
    {

        ErrorMessage = null;
        SuccessMessage = null;

        if (OriginalPixels is null)
        {
            ErrorMessage = $"ç”Ÿæˆå¤±è´¥ï¼šåŸå§‹å›¾åƒå‡ºé”™";
            return;
        }

        if (uploadedFile == null)
        {
            ErrorMessage = "è¯·å…ˆä¸Šä¼ å›¾ç‰‡";
            return;
        }

        if (PixelWidth <= 0 || PixelHeight <= 0)
        {
            ErrorMessage = "è¯·è®¾ç½®æœ‰æ•ˆçš„åƒç´ å¤§å°";
            return;
        }

        Dictionary<string, string> currentPalette = new Dictionary<string, string>();// code, color

        // æŸ¥æ‰¾é€‰ä¸­çš„è°ƒè‰²æ¿
        var selectedPaletteInfo = AllPalettes.FirstOrDefault(p => p.Name == SelectedPalette);
        if (selectedPaletteInfo != null)
        {
            // åŠ è½½å¯¹åº”çš„è°ƒè‰²æ¿æ–‡ä»¶
            var loadedPalette = LoadPaletteFromFile(selectedPaletteInfo.Path);
            currentPalette = loadedPalette;

        }
        else
        {
            // é»˜è®¤ä½¿ç”¨ Mard è°ƒè‰²æ¿
            // for (int i = 0; i < PaletteColors.Count; i++)
            // {
            //     var color = PaletteColors[i];
            //     var code = GetPaletteCode(i);
            //     currentPalette[code] = color;
            // }
        }

        if (currentPalette.Count == 0)
        {
            ErrorMessage = "å½“å‰è°ƒè‰²æ¿ä¸­æ²¡æœ‰é¢œè‰²";
            return;
        }

        IsGenerating = true;

        try
        {

            // åˆ›å»ºè°ƒè‰²æ¿å®ä½“
            var palette = new PaletteEntity();

            // å¡«å……è°ƒè‰²æ¿å®ä½“
            int index = 0;
            foreach (var kvp in currentPalette)
            {
                var colorHex = kvp.Value;
                var color = Vicold.Pindoudou.Entities.Color.FromHex(colorHex);
                palette.AddColor($"Color{index}", color);
                index++;
            }

            // ä½¿ç”¨çœŸå®çš„å›¾åƒæ•°æ®
            var originalWidth = OriginalWidth > 0 ? OriginalWidth : PixelWidth * 10; // ä½¿ç”¨çœŸå®å®½åº¦æˆ–é»˜è®¤å€¼
            var originalHeight = OriginalHeight > 0 ? OriginalHeight : PixelHeight * 10; // ä½¿ç”¨çœŸå®é«˜åº¦æˆ–é»˜è®¤å€¼
            var originalPixels = OriginalPixels; // ä½¿ç”¨çœŸå®åƒç´ æ•°æ®æˆ–æ¨¡æ‹Ÿæ•°æ®

            // ä½¿ç”¨ PixelArtGenerator ç”Ÿæˆåƒç´ å›¾
            var pixelData = PixelArtGenerator.GeneratePixelArt(originalWidth, originalHeight, PixelWidth, PixelHeight, originalPixels, palette);

            PixelArtData = pixelData;
            SuccessMessage = "åƒç´ å›¾ç”ŸæˆæˆåŠŸ";

            // ç®€å•çš„å­—ç¬¦ä¸²ç¼–ç ï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨ JSON åºåˆ—åŒ–
            var pixelDataString = string.Join(",", PixelArtData);
            var paletteColorsString = string.Join(",", currentPalette.Values); // ä½¿ç”¨Valuesè·å–é¢œè‰²å€¼
            
            // å­˜å‚¨åˆ° sessionStorage
            var navigationData = new {
                Width = PixelWidth,
                Height = PixelHeight,
                Palette = SelectedPalette,
                PixelData = pixelDataString,
                PaletteColors = paletteColorsString,
                CurrentPalette = currentPalette
            };
            var jsonData = System.Text.Json.JsonSerializer.Serialize(navigationData);
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "navigationData", jsonData);
            
            // å¯¼èˆªåˆ° Counter é¡µé¢
            NavigationManager.NavigateTo("/counter");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"ç”Ÿæˆå¤±è´¥ï¼š{ex.Message}";
        }
        finally
        {
            IsGenerating = false;
        }
    }

    private string GetPaletteCode(int index)
    {
        // ç”Ÿæˆç±»ä¼¼ A1ã€A2ã€B1ã€B2 çš„è°ƒè‰²æ¿ä»£ç 
        char letter = (char)('A' + (index / 10));
        int number = (index % 10) + 1;
        return $"{letter}{number}";
    }
}