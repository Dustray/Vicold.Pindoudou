@page "/"
@using Microsoft.AspNetCore.Components.Forms
@using System.IO
@using System
@using Vicold.Pindoudou.Entities
@using Vicold.Pindoudou.Utils
@inject NavigationManager NavigationManager

<h1>拼豆图纸设计工具</h1>

<div class="container">
    <div class="row">
        <!-- 左侧控制面板 -->
        <div class="col-md-4">
            <h3>设置</h3>
            
            <!-- 图片上传 -->
            <div class="mb-3">
                <label class="form-label">上传图片</label>
                <InputFile OnChange="LoadImage" accept=".jpg,.jpeg,.png,.gif" />
            </div>
            
            <!-- 像素大小设置 -->
            <div class="mb-3">
                <label class="form-label">像素宽度</label>
                <input type="number" class="form-control" @bind="PixelWidth" min="1" max="100" />
            </div>
            <div class="mb-3">
                <label class="form-label">像素高度</label>
                <input type="number" class="form-control" @bind="PixelHeight" min="1" max="100" />
            </div>
            
            <!-- 调色板选择 -->
            <div class="mb-3">
                <label class="form-label">调色板</label>
                <select class="form-control" @bind="SelectedPalette">
                    <option value="Mard">Mard (默认)</option>
                    <option value="Custom">自定义</option>
                </select>
            </div>
            
            <!-- 自定义调色板管理 -->
            @if (SelectedPalette == "Custom")
            {
                <div class="mb-3">
                    <h4>自定义调色板</h4>
                    <div class="custom-palette">
                        @for (int i = 0; i < CustomPaletteColors.Count; i++)
                        {
                            <div class="palette-color">
                                <input type="color" class="form-control form-control-color" @bind="CustomPaletteColors[i]" />
                                <button class="btn btn-sm btn-danger" @onclick="() => RemoveCustomColor(i)">删除</button>
                            </div>
                        }
                    </div>
                    <button class="btn btn-sm btn-secondary" @onclick="AddCustomColor">添加颜色</button>
                    <button class="btn btn-sm btn-success" @onclick="SaveCustomPalette">保存调色板</button>
                </div>
            }
            
            <!-- 生成按钮 -->
            <button class="btn btn-primary" @onclick="GeneratePixelArt" disabled="@IsGenerating">
                @if (IsGenerating)
                {
                    <span>生成中...</span>
                }
                else
                {
                    <span>生成像素图</span>
                }
            </button>
            
            <!-- 错误消息 -->
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger mt-2">@ErrorMessage</div>
            }
            
            <!-- 成功消息 -->
            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="alert alert-success mt-2">@SuccessMessage</div>
            }
        </div>
        
        <!-- 右侧预览区域 -->
        <div class="col-md-8">
            <h3>预览</h3>
            <div class="preview-container">
                @if (PixelArtData != null)
                {
                    <div class="pixel-art" style="display: inline-block;">
                        @for (int y = 0; y < PixelHeight; y++)
                        {
                            <div class="pixel-row">
                                @for (int x = 0; x < PixelWidth; x++)
                                {
                                    var index = y * PixelWidth + x;
                                    if (index < PixelArtData.Length)
                                    {
                                        var color = PixelArtData[index];
                                        <div class="pixel" style="background-color: @color;"></div>
                                    }
                                }
                            </div>
                        }
                    </div>
                }
                else if (OriginalImageUrl != null)
                {
                    <img src="@OriginalImageUrl" class="original-image" alt="原始图片" />
                }
                else
                {
                    <div class="empty-preview">请上传图片并设置参数</div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .preview-container {
        border: 1px solid #ddd;
        padding: 20px;
        min-height: 400px;
        text-align: center;
        background-color: #f9f9f9;
    }
    
    .pixel-art {
        margin: 0 auto;
    }
    
    .pixel-row {
        display: flex;
    }
    
    .pixel {
        width: 20px;
        height: 20px;
        border: 1px solid #eee;
    }
    
    .original-image {
        max-width: 100%;
        max-height: 400px;
    }
    
    .empty-preview {
        color: #999;
        padding: 100px 0;
    }
    
    .custom-palette {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .palette-color {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .form-control-color {
        width: 60px;
        height: 40px;
        padding: 0;
    }
</style>

@code {
    private int PixelWidth { get; set; } = 20;
    private int PixelHeight { get; set; } = 20;
    private string SelectedPalette { get; set; } = "Mard";
    private string? OriginalImageUrl { get; set; }
    private string[]? PixelArtData { get; set; }
    private IBrowserFile? uploadedFile;
    private Vicold.Pindoudou.Entities.Color[]? OriginalPixels { get; set; }
    private int OriginalWidth { get; set; }
    private int OriginalHeight { get; set; }
    private List<string> PaletteColors { get; set; } = new List<string>();
    private List<string> CustomPaletteColors { get; set; } = new List<string>();
    private bool IsGenerating { get; set; } = false;
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadPalette();
        LoadCustomPalette();
    }

    private void AddCustomColor()
    {
        CustomPaletteColors.Add("#FFFFFF");
    }

    private void RemoveCustomColor(int index)
    {
        if (index >= 0 && index < CustomPaletteColors.Count)
        {
            CustomPaletteColors.RemoveAt(index);
        }
    }

    private void SaveCustomPalette()
    {
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            // 保存自定义调色板到文件
            var palettePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Data", "Palettes", "Custom.txt");
            var directoryPath = Path.GetDirectoryName(palettePath);
            if (!string.IsNullOrEmpty(directoryPath) && !Directory.Exists(directoryPath))
            {
                Directory.CreateDirectory(directoryPath);
            }

            var lines = CustomPaletteColors.Select((color, index) => $"C{index + 1}\t{color}").ToList();
            File.WriteAllLines(palettePath, lines);

            SuccessMessage = "自定义调色板保存成功";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"保存调色板失败：{ex.Message}";
        }
    }

    private void LoadCustomPalette()
    {
        // 加载自定义调色板
        var palettePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Data", "Palettes", "Custom.txt");
        if (!File.Exists(palettePath))
        {
            // 尝试其他可能的路径
            palettePath = Path.Combine(Directory.GetCurrentDirectory(), "Data", "Palettes", "Custom.txt");
        }

        if (File.Exists(palettePath))
        {
            var lines = File.ReadAllLines(palettePath);
            CustomPaletteColors = lines.Select(line => line.Split('\t')[1]).ToList();
        }
        else
        {
            // 如果文件不存在，使用默认颜色
            CustomPaletteColors = new List<string> { "#FFFFFF", "#000000", "#FF0000", "#00FF00", "#0000FF" };
        }
    }

    private async Task LoadPalette()
    {
        // 加载 Mard 调色板
        var palettePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Data", "Palettes", "Mard.txt");
        if (!File.Exists(palettePath))
        {
            // 尝试其他可能的路径
            palettePath = Path.Combine(Directory.GetCurrentDirectory(), "Data", "Palettes", "Mard.txt");
        }

        if (File.Exists(palettePath))
        {
            var lines = await File.ReadAllLinesAsync(palettePath);
            PaletteColors = lines.Select(line => line.Split('\t')[1]).ToList();
        }
        else
        {
            // 如果文件不存在，使用默认颜色
            PaletteColors = new List<string> { "#FFFFFF", "#000000", "#FF0000", "#00FF00", "#0000FF" };
        }
    }

    private async Task LoadImage(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        var stream = uploadedFile.OpenReadStream();
        var memoryStream = new MemoryStream();
        await stream.CopyToAsync(memoryStream);
        memoryStream.Position = 0;

        var bytes = memoryStream.ToArray();
        OriginalImageUrl = $"data:{uploadedFile.ContentType};base64,{Convert.ToBase64String(bytes)}";

        // 使用 Microsoft.Maui.Graphics 获取真实的图像尺寸
        try
        {
            using var imageStream = new MemoryStream(bytes);
            using var image = Microsoft.Maui.Graphics.Platform.PlatformImage.FromStream(imageStream);
            //get pixel data
            OriginalPixels = ImageUtil.GetPixelData(image);
            OriginalWidth = (int)image.Width;
            OriginalHeight = (int)image.Height;
        }
        catch (Exception ex)
        {
            return;
        }
    }
    
    private async Task GeneratePixelArt()
    {
        ErrorMessage = null;
        SuccessMessage = null;
        
        if (uploadedFile == null)
        {
            ErrorMessage = "请先上传图片";
            return;
        }
        
        if (PixelWidth <= 0 || PixelHeight <= 0)
        {
            ErrorMessage = "请设置有效的像素大小";
            return;
        }
        
        var currentPalette = SelectedPalette == "Custom" ? CustomPaletteColors : PaletteColors;
        if (currentPalette.Count == 0)
        {
            ErrorMessage = "当前调色板中没有颜色";
            return;
        }
        
        IsGenerating = true;
        
        try
        {
            // 模拟生成过程的延迟
            await Task.Delay(1000);
            
            // 创建调色板实体
            var palette = new PaletteEntity();
            
            // 填充调色板实体
            for (int i = 0; i < currentPalette.Count; i++)
            {
                var colorHex = currentPalette[i];
                var color = Vicold.Pindoudou.Entities.Color.FromHex(colorHex);
                palette.AddColor($"Color{i}", color);
            }
            
            // 使用真实的图像数据
            var originalWidth = OriginalWidth > 0 ? OriginalWidth : PixelWidth * 10; // 使用真实宽度或默认值
            var originalHeight = OriginalHeight > 0 ? OriginalHeight : PixelHeight * 10; // 使用真实高度或默认值
            var originalPixels = OriginalPixels ?? ImageUtil.GenerateSimulatedImageData(originalWidth, originalHeight); // 使用真实像素数据或模拟数据
            
            // 使用 PixelArtGenerator 生成像素图
            var pixelData = PixelArtGenerator.GeneratePixelArt(originalWidth, originalHeight, PixelWidth, PixelHeight, originalPixels, palette);
            
            PixelArtData = pixelData;
            SuccessMessage = "像素图生成成功";
            
            // 简单的字符串编码，实际应用中应该使用 JSON 序列化
            var pixelDataString = string.Join(",", PixelArtData);
            var paletteColorsString = string.Join(",", currentPalette);
            
            // 导航到 Counter 页面，并传递参数
            NavigationManager.NavigateTo($"/counter?width={PixelWidth}&height={PixelHeight}&palette={SelectedPalette}&pixelData={Uri.EscapeDataString(pixelDataString)}&paletteColors={Uri.EscapeDataString(paletteColorsString)}");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"生成失败：{ex.Message}";
        }
        finally
        {
            IsGenerating = false;
        }
    }
}