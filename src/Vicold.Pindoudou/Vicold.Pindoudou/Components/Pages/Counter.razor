@page "/counter"
@using System.Threading.Tasks
@using System.Collections.Generic
@using Vicold.Pindoudou.Entities
@using Vicold.Pindoudou.Utils
@inject NavigationManager NavigationManager
@inject Microsoft.JSInterop.IJSRuntime JSRuntime

<div class="app-container" @onkeydown="HandleKeyDown" tabindex="0">
    <header class="app-header">
        <h1>æ‹¼è±†å›¾çº¸è®¾è®¡å·¥å…·</h1>
        <p class="app-subtitle">ç¼–è¾‘å’Œè‡ªå®šä¹‰æ‚¨çš„åƒç´ è‰ºæœ¯</p>
    </header>

    <div class="container mt-4">
        <div class="row">
            <!-- å·¦ä¾§è°ƒè‰²æ¿ -->
            <div class="col-md-4">
                <div class="control-panel card shadow-sm">
                    <div class="card-header">
                        <h3>å½“å‰è°ƒè‰²æ¿</h3>
                    </div>
                    <div class="card-body">
                        <div class="palette-display">
                            @if (PaletteColors != null && PaletteColors.Count > 0)
                            {
                                <div class="compact-color-grid scrollable-palette">
                                    @foreach (var kvp in PaletteColors)
                                    {
                                        var color = kvp.Value;
                                        var code = kvp.Key;
                                        var textColor = ColorUtil.GetContrastTextColor(color);
                                        <div 
                                            class="compact-color-item"
                                            @onclick="() => SelectColor(color)"
                                            title="ç‚¹å‡»é€‰æ‹©é¢œè‰²"
                                        >
                                            <div 
                                                class="color-swatch" 
                                                style="background-color: @color"
                                            >
                                                <div class="color-code" style="color: @textColor">@(@code)</div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="text-center text-muted">æ²¡æœ‰å¯ç”¨çš„è°ƒè‰²æ¿é¢œè‰²</p>
                            }
                        </div>
                        
                        <div class="mt-4">
                            <h4>ç¼–è¾‘å·¥å…·</h4>
                            <div class="form-group">
                                <label class="d-block mb-2">å½“å‰é€‰æ‹©çš„é¢œè‰²:</label>
                                <div class="color-preview" style="background-color: @SelectedColor">
                                    <div class="color-code" style="color: @(ColorUtil.GetContrastTextColor(SelectedColor))">@(PaletteColors != null ? PixelArtUtil.GetCodeByColor(SelectedColor, PaletteColors, false) : string.Empty)</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="d-block mb-2">å·¥å…·:</label>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn @(CurrentTool == EditTool.Brush ? "btn-primary" : "btn-outline-primary")" @onclick="() => CurrentTool = EditTool.Brush">ç”»ç¬”</button>
                                    <button type="button" class="btn @(CurrentTool == EditTool.Bucket ? "btn-primary" : "btn-outline-primary")" @onclick="() => CurrentTool = EditTool.Bucket">æ²¹æ¼†æ¡¶</button>
                                    <button type="button" class="btn @(CurrentTool == EditTool.Eraser ? "btn-primary" : "btn-outline-primary")" @onclick="() => CurrentTool = EditTool.Eraser">æ©¡çš®æ“¦</button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="d-block mb-2">æ“ä½œ:</label>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary" @onclick="Undo" title="æ’¤é”€ (Ctrl+Z)">â¬…</button>
                                    <button type="button" class="btn btn-outline-secondary" @onclick="Redo" title="åæ’¤é”€ (Ctrl+Y)">â¡</button>
                                </div>
                            </div>
                            
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="showCodes" @bind="ShowCodes" />
                                <label class="form-check-label" for="showCodes">æ˜¾ç¤ºä»£ç </label>
                            </div>
                            
                            <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="hideTransparentCodes" @bind="HideTransparentCodes" />
                                <label class="form-check-label" for="hideTransparentCodes">éšè—é€æ˜è‰²ä»£ç </label>
                            </div>
                            
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-primary flex-fill" @onclick="ExportPixelArt">å¯¼å‡ºå›¾ç‰‡</button>
                                <button class="btn btn-primary flex-fill" @onclick="SaveResource">ä¿å­˜èµ„æº</button>
                                <button class="btn btn-success flex-fill" @onclick="OpenResource">æ‰“å¼€èµ„æº</button>
                                <button class="btn btn-secondary flex-fill" @onclick="GoBack">è¿”å›</button>
                            </div>
                        </div>
                     @if (!string.IsNullOrEmpty(Message))
                    {
                        <div class="alert alert-info" role="alert">
                            @Message
                        </div>
                    }
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§åƒç´ å›¾ç¼–è¾‘åŒºåŸŸ -->
            <div class="col-md-8">
                <div class="preview-panel card shadow-sm">
                    <div class="card-header">
                        <h3>åƒç´ å›¾ç¼–è¾‘</h3>
                    </div>
                    <div class="card-body">
                        <div class="edit-container">
                            @if (PixelData != null && PixelData.Length > 0)
                            {
                                <div class="zoomable-container" id="zoomableContainer" @onmouseleave="StopDrawing">
                                    <div class="zoomable-content" id="zoomableContent" style="transform-origin: 0 0;">
                                        <div class="pixel-art">
                                            @for (int y = 0; y < Height; y++)
                                            {
                                                <div class="pixel-row">
                                                    @for (int x = 0; x < Width; x++)
                                                    {
                                                        var currentX = x;
                                                        var currentY = y;
                                                        var index = y * Width + x;
                                                        if (index < PixelData.Length)
                                                        {
                                                            <div 
                                                                class="pixel" 
                                                                style="background-color: @PixelData[index]"
                                                                @onmousedown="(e) => HandleMouseDown(currentX, currentY, e)"
                                                                @onmousedown:preventDefault="true"
                                                                @onmouseup="StopDrawing"
                                                                @onmouseover="() => DrawIfMouseDown(currentX, currentY)"
                                                                title="@PixelData[index]"
                                                            >
                                                                @if (ShowCodes && PaletteColors != null)
                                                                {
                                                                    var code = PixelArtUtil.GetCodeByColor(PixelData[index], PaletteColors, HideTransparentCodes);
                                                                    if (!string.IsNullOrEmpty(code))
                                                                    {
                                                                        var textColor = ColorUtil.GetContrastTextColor(PixelData[index]);
                                                                        <div class="color-number-in-pixel" style="color: @textColor">
                                                                            @(code)
                                                                        </div>
                                                                    }
                                                                }
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="empty-state">
                                    <div class="empty-icon">ğŸ¨</div>
                                    <div class="empty-text">æ²¡æœ‰å¯ç¼–è¾‘çš„åƒç´ å›¾</div>
                                    <div class="empty-subtext">è¯·å…ˆåœ¨ä¸»é¡µç”Ÿæˆåƒç´ å›¾</div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* ç¼–è¾‘å®¹å™¨æ ·å¼ */
    .edit-container {
        border: 2px dashed #dee2e6;
        padding: 20px;
        min-height: 700px;
        text-align: center;
        background-color: #ffffff;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .edit-container:hover {
        border-color: #667eea;
        background-color: #f8f9ff;
    }
    
    /* ç¼©æ”¾å®¹å™¨æ ·å¼ */
    .zoomable-container {
        width: 100%;
        height: 650px;
        overflow: hidden;
        position: relative;
        background-color: #fff;
        border: 1px solid #eee;
        cursor: grab;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .zoomable-container:active {
        cursor: grabbing;
    }
    
    .zoomable-content {
        position: absolute;
        top: 0;
        left: 0;
        transform: scale(1);
        transition: transform 0.1s ease;
    }
    
    /* åƒç´ è‰ºæœ¯æ ·å¼ */
    .pixel-art {
        margin: 0;
    }
    
    .pixel {
        width: 20px;
        height: 20px;
        border: 1px solid #e0e0e0;
        cursor: pointer;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        transition: transform 0.2s ease, border-color 0.2s ease;
    }
    
    .pixel:hover {
        border: 1px solid #667eea;
        transform: scale(1.05);
        z-index: 1;
    }
    
    /* è°ƒè‰²æ¿æ ·å¼ */
    .palette-display {
        border: 1px solid #e9ecef;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 20px;
        max-height: 400px;
        overflow: hidden;
    }
    
    .scrollable-palette {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        justify-content: flex-start;
        max-height: 380px;
        overflow-y: auto;
        padding-right: 5px;
    }
    
    /* æ»šåŠ¨æ¡æ ·å¼ */
    .scrollable-palette::-webkit-scrollbar {
        width: 6px;
    }
    
    .scrollable-palette::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .scrollable-palette::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    .scrollable-palette::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    .compact-color-item {
        cursor: pointer;
        margin-bottom: 4px;
        transition: all 0.2s ease;
    }
    
    .compact-color-item:hover {
        transform: translateY(-2px);
    }
    
    .color-swatch {
        width: 40px;
        height: 40px;
        border: 2px solid #e0e0e0;
        border-radius: 4px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .compact-color-item:hover .color-swatch {
        border: 2px solid #667eea;
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        transform: scale(1.05);
    }

    .color-code {
        font-size: 12px;
        font-weight: bold;
        text-align: center;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* å›ºå®šå³ä¾§ç¼–è¾‘åŒºåŸŸ */
    @@media (min-width: 768px) {
        .col-md-8 {
            position: sticky;
            top: 20px;
            align-self: flex-start;
        }
    }

    .color-number-in-pixel {
        font-size: 9px;
        color: #333;
        text-align: center;
        width: 100%;
        font-weight: bold;
        line-height: 1;
        margin: 0;
        padding: 0;
    }
    
    /* é¢œè‰²é¢„è§ˆæ ·å¼ */
    .color-preview {
        width: 80px;
        height: 50px;
        border: 2px solid #e0e0e0;
        margin-right: 10px;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .color-preview:hover {
        border-color: #667eea;
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }
    
    /* è¡¨å•å…ƒç´ æ ·å¼ */
    .form-control-color {
        width: 80px;
        height: 50px;
        padding: 0;
        border-radius: 6px;
        border: 2px solid #ced4da;
        transition: all 0.3s ease;
    }

    .form-control-color:hover {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    /* ç©ºçŠ¶æ€æ ·å¼ */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        min-height: 500px;
        color: #999;
        text-align: center;
    }

    .empty-icon {
        font-size: 5rem;
        margin-bottom: 20px;
        opacity: 0.6;
    }

    .empty-text {
        font-size: 1.2rem;
        margin-bottom: 10px;
        font-weight: 500;
        color: #666;
    }

    .empty-subtext {
        font-size: 1rem;
        color: #999;
    }

    /* å“åº”å¼è®¾è®¡ */
    @@media (max-width: 768px) {
        .edit-container {
            min-height: 500px;
            padding: 15px;
        }

        .zoomable-container {
            height: 450px;
        }

        .pixel {
            width: 18px;
            height: 18px;
        }

        .compact-color-item {
            width: 40px;
        }

        .color-swatch {
            width: 30px;
            height: 30px;
        }
    }
</style>

@code {
    private enum EditTool
    {
        Brush,
        Bucket,
        Eraser
    }
    
    private string[]? PixelData { get; set; }
    private int Width { get; set; }
    private int Height { get; set; }
    private string Palette { get; set; } = "Mard";
    private Dictionary<string, string> PaletteColors { get; set; } = new Dictionary<string, string>();
    private string SelectedColor { get; set; } = "#FFFFFF";
    private bool ShowCodes { get; set; } = true;
    private bool HideTransparentCodes { get; set; } = false;
    private string Message { get; set; } = string.Empty;
    private bool IsDrawing { get; set; } = false;
    private EditTool CurrentTool { get; set; } = EditTool.Brush;
    private Stack<string[]> UndoStack { get; set; } = new Stack<string[]>();
    private Stack<string[]> RedoStack { get; set; } = new Stack<string[]>();

    protected override async Task OnInitializedAsync()
    {
        // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„çŠ¶æ€
        var savedStateJson = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "counterState");
        
        if (!string.IsNullOrEmpty(savedStateJson))
        {
            try
            {
                // ä½¿ç”¨å…·ä½“çš„ç±»å‹è€Œä¸æ˜¯dynamic
                var options = new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                };
                
                var navigationData = System.Text.Json.JsonSerializer.Deserialize<NavigationData>(savedStateJson, options);
                
                if (navigationData != null)
                {
                    // è§£æå‚æ•°
                    Width = navigationData.Width;
                    Height = navigationData.Height;
                    Palette = navigationData.Palette;
                    
                    // è§£æåƒç´ æ•°æ®
                    var pixelDataString = navigationData.PixelData;
                    if (!string.IsNullOrEmpty(pixelDataString))
                    {
                        PixelData = pixelDataString.Split(',');
                    }
                    
                    // è§£æè°ƒè‰²æ¿é¢œè‰²
                    var paletteColorsString = navigationData.CurrentPalette;
                    foreach (var color in paletteColorsString)
                    {
                        PaletteColors[color.Key] = color.Value; // codeä¸ºkeyï¼Œcolorä¸ºvalue
                    }
                    
                    // è®¾ç½®é»˜è®¤é€‰æ‹©çš„é¢œè‰²
                    if (PaletteColors.Count > 0)
                    {
                        SelectedColor = PaletteColors.First().Value;
                    }
                }
                
                // ä¿ç•™ä¿å­˜çš„çŠ¶æ€ï¼Œä»¥ä¾¿åç»­å¯¼èˆªå›æ¥æ—¶ä»èƒ½ä½¿ç”¨
                // æ³¨æ„ï¼šä¸è¦æ¸…é™¤ sessionStorage ä¸­çš„æ•°æ®
            }
            catch (Exception ex)
            {
                // é”™è¯¯å¤„ç†
                Console.WriteLine($"Error parsing saved state: {ex.Message}");
                // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•ä»å¯¼èˆªæ•°æ®ä¸­è·å–
                await LoadFromNavigationData();
            }
        }
        else
        {
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œå°è¯•ä»å¯¼èˆªæ•°æ®ä¸­è·å–
            await LoadFromNavigationData();
        }
    }
    
    private async Task LoadFromNavigationData()
    {
        // ä» sessionStorage ä¸­è·å–å¯¼èˆªæ•°æ®
        var jsonData = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "navigationData");
        
        if (!string.IsNullOrEmpty(jsonData))
        {
            try
            {
                // ä½¿ç”¨å…·ä½“çš„ç±»å‹è€Œä¸æ˜¯dynamic
                var options = new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                };
                
                var navigationData = System.Text.Json.JsonSerializer.Deserialize<NavigationData>(jsonData, options);
                
                if (navigationData != null)
                {
                    // è§£æå‚æ•°
                    Width = navigationData.Width;
                    Height = navigationData.Height;
                    Palette = navigationData.Palette;
                    
                    // è§£æåƒç´ æ•°æ®
                    var pixelDataString = navigationData.PixelData;
                    if (!string.IsNullOrEmpty(pixelDataString))
                    {
                        PixelData = pixelDataString.Split(',');
                    }
                    
                    // è§£æè°ƒè‰²æ¿é¢œè‰²
                    var paletteColorsString = navigationData.CurrentPalette;
                    foreach (var color in paletteColorsString)
                    {
                        PaletteColors[color.Key] = color.Value; // codeä¸ºkeyï¼Œcolorä¸ºvalue
                    }
                    
                    // è®¾ç½®é»˜è®¤é€‰æ‹©çš„é¢œè‰²
                    if (PaletteColors.Count > 0)
                    {
                        SelectedColor = PaletteColors.First().Value;
                    }
                }
                
                // æ¸…é™¤ sessionStorage ä¸­çš„å¯¼èˆªæ•°æ®
                await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", "navigationData");
            }
            catch (Exception ex)
            {
                // é”™è¯¯å¤„ç†
                Console.WriteLine($"Error parsing navigation data: {ex.Message}");
                // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
                Width = 20;
                Height = 20;
                Palette = "Mard";
                PaletteColors = new Dictionary<string, string>();
                SelectedColor = "#FFFFFF";
            }
        }
        else
        {
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼
            Width = 20;
            Height = 20;
            Palette = "Mard";
            PaletteColors = new Dictionary<string, string>();
            SelectedColor = "#FFFFFF";
        }
    }
    
    private async Task EditPixel(int x, int y)
    {
        string targetColor = SelectedColor;
        if (CurrentTool == EditTool.Eraser)
        {
            targetColor = "#FFFFFF00";
        }
        
        Message = $"ç¼–è¾‘åƒç´ : x={x}, y={y}, é¢œè‰²={targetColor}";
        Console.WriteLine($"EditPixel called with x={x}, y={y}, TargetColor={targetColor}, Tool={CurrentTool}");
        if (PixelData != null)
        {
            // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€æ ˆ
            var currentState = new string[PixelData.Length];
            Array.Copy(PixelData, currentState, PixelData.Length);
            UndoStack.Push(currentState);
            
            // æ¸…ç©ºé‡åšæ ˆ
            RedoStack.Clear();
            
            Console.WriteLine($"PixelData length: {PixelData.Length}");
            string[] newPixelData;
            
            if (CurrentTool == EditTool.Brush || CurrentTool == EditTool.Eraser)
            {
                // ç”»ç¬”æˆ–æ©¡çš®æ“¦å·¥å…·ï¼šç¼–è¾‘å•ä¸ªåƒç´ 
                newPixelData = PixelArtUtil.EditPixel(x, y, Width, PixelData, targetColor);
            }
            else
            {
                // æ²¹æ¼†æ¡¶å·¥å…·ï¼šæ´ªæ°´å¡«å……
                newPixelData = FloodFill(x, y, targetColor, PixelData);
            }
            
            Console.WriteLine($"New PixelData length: {newPixelData.Length}");
            PixelData = newPixelData;
            Console.WriteLine($"PixelData updated successfully");
            Message += " - æˆåŠŸ";
            
            // ä¿å­˜å½“å‰çŠ¶æ€
            await SaveCurrentState();
        }
        else
        {
            Console.WriteLine("PixelData is null");
            Message += " - å¤±è´¥: PixelDataä¸ºnull";
        }
    }
    
    private string[] FloodFill(int startX, int startY, string newColor, string[] pixelData)
    {
        // åˆ›å»ºåƒç´ æ•°æ®çš„å‰¯æœ¬
        var result = new string[pixelData.Length];
        Array.Copy(pixelData, result, pixelData.Length);
        
        // è·å–èµ·å§‹åƒç´ çš„é¢œè‰²
        int startIndex = startY * Width + startX;
        string targetColor = pixelData[startIndex];
        
        // å¦‚æœç›®æ ‡é¢œè‰²ä¸æ–°é¢œè‰²ç›¸åŒï¼Œç›´æ¥è¿”å›
        if (targetColor == newColor)
        {
            return result;
        }
        
        // ä½¿ç”¨é˜Ÿåˆ—å®ç°æ´ªæ°´å¡«å……
        var queue = new Queue<(int, int)>();
        queue.Enqueue((startX, startY));
        
        while (queue.Count > 0)
        {
            var (x, y) = queue.Dequeue();
            
            // æ£€æŸ¥åæ ‡æ˜¯å¦æœ‰æ•ˆ
            if (x < 0 || x >= Width || y < 0 || y >= Height)
            {
                continue;
            }
            
            int index = y * Width + x;
            
            // æ£€æŸ¥å½“å‰åƒç´ é¢œè‰²æ˜¯å¦ä¸ç›®æ ‡é¢œè‰²ç›¸åŒ
            if (result[index] == targetColor)
            {
                // è®¾ç½®æ–°é¢œè‰²
                result[index] = newColor;
                
                // å°†ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘çš„åƒç´ åŠ å…¥é˜Ÿåˆ—
                queue.Enqueue((x - 1, y)); // å·¦
                queue.Enqueue((x + 1, y)); // å³
                queue.Enqueue((x, y - 1)); // ä¸Š
                queue.Enqueue((x, y + 1)); // ä¸‹
            }
        }
        
        return result;
    }
    
    private void SelectColor(string color)
    {
        Message = $"é€‰æ‹©é¢œè‰²: {color}";
        Console.WriteLine($"SelectColor called with color={color}");
        SelectedColor = color;
        Console.WriteLine($"SelectedColor updated to: {SelectedColor}");
    }
    
    private bool IsBatchEditing { get; set; } = false;
    
    private async Task HandleMouseDown(int x, int y, MouseEventArgs e)
    {
        // å·¦é”®å¼€å§‹æ‰¹é‡ä¿®æ”¹
        if (e.Button == 0)
        {
            IsBatchEditing = true;
            await EditPixel(x, y);
        }
        // å³é”®ä¸åšä»»ä½•å¤„ç†ï¼Œè®©å®ƒè§¦å‘zoomableContainerçš„æ‹–åŠ¨åŠŸèƒ½
    }
    
    private void StopDrawing()
    {
        IsBatchEditing = false;
    }
    
    private async Task DrawIfMouseDown(int x, int y)
    {
        if (IsBatchEditing)
        {
            await EditPixel(x, y);
        }
    }
    
    private async Task Undo()
    {
        if (UndoStack.Count > 0 && PixelData != null)
        {
            // ä¿å­˜å½“å‰çŠ¶æ€åˆ°é‡åšæ ˆ
            var currentState = new string[PixelData.Length];
            Array.Copy(PixelData, currentState, PixelData.Length);
            RedoStack.Push(currentState);
            
            // ä»æ’¤é”€æ ˆä¸­å¼¹å‡ºä¸Šä¸€ä¸ªçŠ¶æ€
            PixelData = UndoStack.Pop();
            Message = "æ’¤é”€æ“ä½œæˆåŠŸ";
            Console.WriteLine("Undo operation performed");
            
            // ä¿å­˜å½“å‰çŠ¶æ€
            await SaveCurrentState();
        }
        else
        {
            Message = "æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ";
            Console.WriteLine("No undo operations available");
        }
    }
    
    private async Task Redo()
    {
        if (RedoStack.Count > 0 && PixelData != null)
        {
            // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€æ ˆ
            var currentState = new string[PixelData.Length];
            Array.Copy(PixelData, currentState, PixelData.Length);
            UndoStack.Push(currentState);
            
            // ä»é‡åšæ ˆä¸­å¼¹å‡ºä¸‹ä¸€ä¸ªçŠ¶æ€
            PixelData = RedoStack.Pop();
            Message = "åæ’¤é”€æ“ä½œæˆåŠŸ";
            Console.WriteLine("Redo operation performed");
            
            // ä¿å­˜å½“å‰çŠ¶æ€
            await SaveCurrentState();
        }
        else
        {
            Message = "æ²¡æœ‰å¯åæ’¤é”€çš„æ“ä½œ";
            Console.WriteLine("No redo operations available");
        }
    }
    
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        // å¤„ç†Ctrl+Zæ’¤é”€æ“ä½œ
        if (e.CtrlKey && e.Key == "z")
        {
            await Undo();
        }
        // å¤„ç†Ctrl+Yåæ’¤é”€æ“ä½œ
        else if (e.CtrlKey && e.Key == "y")
        {
            await Redo();
        }
    }
    
    private async Task GoBack()
    {
        // ä¿å­˜å½“å‰çŠ¶æ€åˆ° sessionStorage
        await SaveCurrentState();
        NavigationManager.NavigateTo("/");
    }
    
    private async Task SaveCurrentState()
    {
        if (PixelData != null && PixelData.Length > 0)
        {
            var navigationData = new NavigationData
            {
                Width = Width,
                Height = Height,
                Palette = Palette,
                PixelData = string.Join(",", PixelData),
                CurrentPalette = PaletteColors
            };
            
            var jsonData = System.Text.Json.JsonSerializer.Serialize(navigationData);
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "counterState", jsonData);
        }
    }
    
    private async Task ExportPixelArt()
    {
        if (PixelData != null && PixelData.Length > 0)
        {
            await JSRuntime.InvokeVoidAsync("exportPixelArtAsImage", Width, Height, PixelData, PaletteColors, ShowCodes, HideTransparentCodes);
        }
    }
    
    private async Task SaveResource()
    {
        if (PixelData != null && PixelData.Length > 0 && PaletteColors != null && PaletteColors.Count > 0)
        {
            // åˆ›å»ºèµ„æºæ•°æ®
            var resourceData = new
            {
                Width = Width,
                Height = Height,
                Palette = PaletteColors.Select(kvp => new { Name = kvp.Key, Color = kvp.Value }).ToList(),
                PixelData = PixelData
            };
            
            // åºåˆ—åŒ–ä¸º JSONï¼ˆå‹ç¼©æ ¼å¼ï¼‰
            var json = System.Text.Json.JsonSerializer.Serialize(resourceData, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = false
            });
            
            // è°ƒç”¨ JavaScript ä¿å­˜æ–‡ä»¶
            await JSRuntime.InvokeVoidAsync("saveResourceFile", json);
        }
        else
        {
            Message = "æ²¡æœ‰å¯ä¿å­˜çš„èµ„æºæ•°æ®";
        }
    }
    
    private async Task OpenResource()
    {
        // è°ƒç”¨ JavaScript æ‰“å¼€æ–‡ä»¶å¯¹è¯æ¡†
        var result = await JSRuntime.InvokeAsync<string>("openResourceFile");
        
        if (!string.IsNullOrEmpty(result))
        {
            try
            {
                // ååºåˆ—åŒ–èµ„æºæ•°æ®
                var options = new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                };
                
                // ä½¿ç”¨å¼ºç±»å‹ååºåˆ—åŒ–
                var resourceData = System.Text.Json.JsonSerializer.Deserialize<ResourceData>(result, options);
                
                if (resourceData != null)
                {
                    // æå–æ•°æ®
                    Width = resourceData.Width;
                    Height = resourceData.Height;
                    PixelData = resourceData.PixelData;
                    
                    // é‡å»ºè°ƒè‰²æ¿
                    PaletteColors.Clear();
                    foreach (var colorItem in resourceData.Palette)
                    {
                        var name = colorItem.Name;
                        var color = colorItem.Color;
                        PaletteColors[name] = color;
                    }
                    
                    // è®¾ç½®é»˜è®¤é€‰æ‹©çš„é¢œè‰²
                    if (PaletteColors.Count > 0)
                    {
                        SelectedColor = PaletteColors.First().Value;
                    }
                    
                    Message = "èµ„æºæ–‡ä»¶æ‰“å¼€æˆåŠŸ";
                    
                    // ä¿å­˜å½“å‰çŠ¶æ€
                    await SaveCurrentState();
                }
            }
            catch (Exception ex)
            {
                Message = $"æ‰“å¼€èµ„æºæ–‡ä»¶å¤±è´¥: {ex.Message}";
                Console.WriteLine($"Error opening resource file: {ex.Message}");
            }
        }
    }
    
    // èµ„æºæ•°æ®ç»“æ„
    private class ResourceData
    {
        public int Width { get; set; }
        public int Height { get; set; }
        public List<PaletteColor> Palette { get; set; } = new List<PaletteColor>();
        public string[] PixelData { get; set; } = Array.Empty<string>();
    }
    
    // è°ƒè‰²æ¿é¢œè‰²ç»“æ„
    private class PaletteColor
    {
        public string Name { get; set; } = string.Empty;
        public string Color { get; set; } = string.Empty;
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (PixelData != null && PixelData.Length > 0)
        {
            // å»¶è¿Ÿè°ƒç”¨ï¼Œç¡®ä¿ DOM å…ƒç´ å·²ç»å®Œå…¨æ¸²æŸ“
            await Task.Delay(100);
            await JSRuntime.InvokeVoidAsync("initializeZoomAndPan");
        }
    }
}
