@page "/counter"
@inject NavigationManager NavigationManager

<h1>编辑</h1>

<div class="container">
    <div class="row">
        <!-- 左侧调色板 -->
        <div class="col-md-4">
            <h3>当前调色板</h3>
            <div class="palette-display">
                @if (PaletteColors != null && PaletteColors.Count > 0)
                {
                    <div class="color-grid">
                        @for (int i = 0; i < PaletteColors.Count; i++)
                        {
                            <div 
                                class="color-item" 
                                style="background-color: @PaletteColors[i]" 
                                @onclick="() => SelectColor(PaletteColors[i])"
                                title="点击选择颜色"
                            ></div>
                        }
                    </div>
                }
                else
                {
                    <p>没有可用的调色板颜色</p>
                }
            </div>
            
            <div class="mt-3">
                <h4>编辑工具</h4>
                <div class="form-group">
                    <label>当前选择的颜色:</label>
                    <div class="color-preview" style="background-color: @SelectedColor"></div>
                    <input type="color" @bind="SelectedColor" class="form-control form-control-color" />
                </div>
                
                <button class="btn btn-secondary mt-2" @onclick="GoBack">返回</button>
            </div>
        </div>
        
        <!-- 右侧像素图编辑区域 -->
        <div class="col-md-8">
            <h3>像素图编辑</h3>
            <div class="edit-container">
                @if (PixelData != null && PixelData.Length > 0)
                {
                    <div class="pixel-art" style="display: inline-block;">
                        @for (int y = 0; y < Height; y++)
                        {
                            <div class="pixel-row">
                                @for (int x = 0; x < Width; x++)
                                {
                                    var index = y * Width + x;
                                    if (index < PixelData.Length)
                                    {
                                        <div 
                                            class="pixel" 
                                            style="background-color: @PixelData[index]"
                                            @onclick="() => EditPixel(x, y)"
                                            title="点击编辑像素"
                                        ></div>
                                    }
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p>没有可编辑的像素图</p>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .edit-container {
        border: 1px solid #ddd;
        padding: 20px;
        min-height: 400px;
        text-align: center;
        background-color: #f9f9f9;
    }
    
    .pixel-art {
        margin: 0 auto;
    }
    
    .pixel-row {
        display: flex;
    }
    
    .pixel {
        width: 20px;
        height: 20px;
        border: 1px solid #eee;
        cursor: pointer;
    }
    
    .pixel:hover {
        border: 1px solid #000;
    }
    
    .palette-display {
        border: 1px solid #ddd;
        padding: 10px;
        background-color: #f9f9f9;
    }
    
    .color-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .color-item {
        width: 30px;
        height: 30px;
        border: 1px solid #ddd;
        cursor: pointer;
    }
    
    .color-item:hover {
        border: 1px solid #000;
    }
    
    .color-preview {
        width: 60px;
        height: 40px;
        border: 1px solid #ddd;
        margin-bottom: 10px;
    }
    
    .form-control-color {
        width: 60px;
        height: 40px;
        padding: 0;
    }
</style>

@code {
    private string[]? PixelData { get; set; }
    private int Width { get; set; }
    private int Height { get; set; }
    private string Palette { get; set; } = "Mard";
    private List<string> PaletteColors { get; set; } = new List<string>();
    private string SelectedColor { get; set; } = "#FFFFFF";
    
    protected override void OnInitialized()
    {
        // 从 URL 参数中获取数据
        var uri = new Uri(NavigationManager.Uri);
        var queryString = uri.Query;
        
        // 解析参数
        Width = GetQueryParameter(queryString, "width", 20);
        Height = GetQueryParameter(queryString, "height", 20);
        Palette = GetQueryParameter(queryString, "palette", "Mard");
        
        // 解析像素数据
        var pixelDataString = GetQueryParameter(queryString, "pixelData", "");
        if (!string.IsNullOrEmpty(pixelDataString))
        {
            PixelData = pixelDataString.Split(',');
        }
        
        // 解析调色板颜色
        var paletteColorsString = GetQueryParameter(queryString, "paletteColors", "");
        if (!string.IsNullOrEmpty(paletteColorsString))
        {
            PaletteColors = paletteColorsString.Split(',').ToList();
        }
        
        // 设置默认选择的颜色
        if (PaletteColors.Count > 0)
        {
            SelectedColor = PaletteColors[0];
        }
    }
    
    private int GetQueryParameter(string queryString, string parameterName, int defaultValue)
    {
        var parameter = GetQueryParameter(queryString, parameterName, string.Empty);
        if (int.TryParse(parameter, out var value))
        {
            return value;
        }
        return defaultValue;
    }
    
    private string GetQueryParameter(string queryString, string parameterName, string defaultValue)
    {
        if (string.IsNullOrEmpty(queryString))
        {
            return defaultValue;
        }
        
        // 移除开头的 ?
        if (queryString.StartsWith("?"))
        {
            queryString = queryString.Substring(1);
        }
        
        // 分割参数
        var parameters = queryString.Split('&');
        foreach (var param in parameters)
        {
            var parts = param.Split('=');
            if (parts.Length == 2 && parts[0] == parameterName)
            {
                return Uri.UnescapeDataString(parts[1]);
            }
        }
        
        return defaultValue;
    }
    
    private void EditPixel(int x, int y)
    {
        var index = y * Width + x;
        if (index >= 0 && index < PixelData?.Length)
        {
            PixelData[index] = SelectedColor;
        }
    }
    
    private void SelectColor(string color)
    {
        SelectedColor = color;
    }
    
    private void GoBack()
    {
        NavigationManager.NavigateTo("/");
    }
}
