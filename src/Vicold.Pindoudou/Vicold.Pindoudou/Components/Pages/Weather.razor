@page "/weather"
@using System.IO
@using System
@using Microsoft.Maui.Storage

<h1>调色板管理工具</h1>

<div class="container">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2>现有调色板</h2>
            <div class="list-group">
                <button class="list-group-item list-group-item-action @GetActiveClass("Mard")" @onclick="LoadMardPalette">
                    Mard (默认)
                </button>
                @foreach (var userPalette in UserPalettes)
                {
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <button class="btn btn-link text-left flex-grow-1 @GetBoldClass(userPalette)" @onclick="() => LoadUserPalette(userPalette)">
                            @userPalette
                        </button>
                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteUserPalette(userPalette)" disabled="@IsSelected(userPalette)">
                            删除
                        </button>
                    </div>
                }
            </div>
        </div>
        <div class="col-md-6">
            <h2>基于当前调色板创建新调色板</h2>
            <div class="mb-3">
                <label for="newPaletteName" class="form-label">新调色板名称</label>
                <input type="text" class="form-control" id="newPaletteName" @bind="NewPaletteName" placeholder="输入调色板名称">
                <div class="text-muted text-xs mt-1">当前值: '@NewPaletteName'</div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <h2>从默认 Mard 调色板选择颜色</h2>
            <div class="mb-3">
                <label class="form-label">选择颜色 (可多选)</label>
                <div class="d-flex flex-wrap gap-1 p-3 border rounded">
                    @foreach (var item in MardPaletteColors)
                    {
                        <div class="color-item d-flex flex-column align-items-center" style="width: 35px; margin: 2px; cursor: pointer;" @onclick="() => ToggleColorSelection(item.Color)">
                        <div class="color-block position-relative" style="width: 30px; height: 30px; background-color: @item.Color; border: 1px solid #ddd; border-radius: 3px;">
                            @if (SelectedColors.Contains(item.Color))
                            {
                                <div class="position-absolute top-0 right-0 bg-white text-black flex items-center justify-center rounded-full border border-gray-300" style="width: 14px; height: 14px; font-size: 10px;">
                                    ✓
                                </div>
                            }
                        </div>
                        <span class="text-xs mt-1">@item.Code</span>
                    </div>
                    }
                </div>
            </div>
            <div class="mb-3">
                <label for="colorCodesInput" class="form-label">输入颜色代码 (如: A1 A4 A15)</label>
                <input type="text" class="form-control" id="colorCodesInput" @bind="ColorCodesInput" placeholder="输入颜色代码，用空格分隔">
            </div>
            <button class="btn btn-primary" @onclick="SelectColorsByCodes">
                一键选中颜色
            </button>
            <button class="btn btn-success ml-2" @onclick="async () => await CreatePaletteFromSelection()">
                基于选择的颜色创建新调色板
            </button>
            <span class="text-muted ml-2">已选择 @SelectedColors.Count 个颜色</span>
            <div class="text-muted text-xs mt-1">NewPaletteName: '@NewPaletteName', SelectedColors.Count: @SelectedColors.Count</div>
        </div>
    </div>



    <div class="row mt-4">
        <div class="col-md-12">
            <h2>调色板预览</h2>
            <div class="palette-preview d-flex flex-wrap gap-0">
                @foreach (var color in PaletteColors)
                {
                    <div class="preview-color" style="width: 15px; height: 15px; background-color: @color; border: 1px solid #eee;"></div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .color-item:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .palette-preview {
        max-width: 100%;
        overflow-x: auto;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 4px;
    }
</style>

@code {
    private List<string> UserPalettes { get; set; } = new List<string>();
    private string SelectedPaletteName { get; set; } = "Mard";
    private List<string> PaletteColors { get; set; } = new List<string>();
    private List<(string Code, string Color)> MardPaletteColors { get; set; } = new List<(string Code, string Color)>();
    private List<string> SelectedColors { get; set; } = new List<string>();
    private string ColorCodesInput { get; set; } = string.Empty;
    private string NewPaletteName { get; set; } = string.Empty;
    private string PaletteDescription { get; set; } = string.Empty;
    private string SuccessMessage { get; set; } = string.Empty;
    private string ErrorMessage { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        LoadUserPalettes();
        await LoadMardPaletteColors();
        await LoadPalette("Mard");
    }

    private async Task LoadMardPaletteColors()
    {
        try
        {
            // 使用跨平台兼容的应用数据目录
            string appDataDir = FileSystem.AppDataDirectory;
            var palettePath = Path.Combine(appDataDir, "Data", "Palettes", "Mard.txt");
            
            if (!File.Exists(palettePath))
            {
                // 尝试使用应用程序基础目录（用于Windows调试）
                string baseDir = AppDomain.CurrentDomain.BaseDirectory;
                palettePath = Path.Combine(baseDir, "Data", "Palettes", "Mard.txt");
            }

            if (!File.Exists(palettePath))
            {
                // 尝试使用当前工作目录
                palettePath = Path.Combine(Directory.GetCurrentDirectory(), "Data", "Palettes", "Mard.txt");
            }

            if (File.Exists(palettePath))
            {
                var lines = await File.ReadAllLinesAsync(palettePath);
                MardPaletteColors = lines.Select(line => {
                    var parts = line.Split('\t');
                    return (Code: parts[0], Color: parts[1]);
                }).ToList();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"加载 Mard 调色板失败：{ex.Message}";
        }
    }

    private void ToggleColorSelection(string color)
    {
        if (SelectedColors.Contains(color))
        {
            SelectedColors.Remove(color);
        }
        else
        {
            SelectedColors.Add(color);
        }
    }

    private void SelectColorsByCodes()
    {
        SuccessMessage = string.Empty;
        ErrorMessage = string.Empty;
        
        try
        {
            var codes = ColorCodesInput.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (codes.Length == 0)
            {
                ErrorMessage = "请输入颜色代码";
                return;
            }
            
            SelectedColors.Clear();
            foreach (var code in codes)
            {
                var colorItem = MardPaletteColors.FirstOrDefault(item => item.Code == code);
                if (colorItem.Code != null)
                {
                    SelectedColors.Add(colorItem.Color);
                }
            }
            
            if (SelectedColors.Count == 0)
            {
                ErrorMessage = "未找到匹配的颜色代码";
            }
            else
            {
                SuccessMessage = $"成功选中 {SelectedColors.Count} 个颜色";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"选择颜色失败：{ex.Message}";
        }
    }

    private async Task CreatePaletteFromSelection()
    {
        SuccessMessage = string.Empty;
        ErrorMessage = string.Empty;
        
        if (string.IsNullOrWhiteSpace(NewPaletteName))
        {
            ErrorMessage = "请输入调色板名称";
            return;
        }
        
        if (SelectedColors.Count == 0)
        {
            ErrorMessage = "请至少选择一个颜色";
            return;
        }
        
        if (UserPalettes.Contains(NewPaletteName))
        {
            ErrorMessage = "该名称的调色板已存在";
            return;
        }
        
        try
        {
            // 使用跨平台兼容的应用数据目录
            string appDataDir = FileSystem.AppDataDirectory;
            string userPalettesPath = Path.Combine(appDataDir, "Data", "UserPalettes");
            
            if (!Directory.Exists(userPalettesPath))
            {
                Directory.CreateDirectory(userPalettesPath);
            }
            
            var palettePath = Path.Combine(userPalettesPath, $"{NewPaletteName}.txt");
            var lines = SelectedColors.Select(color => {
                // 查找颜色对应的原始代码
                var colorItem = MardPaletteColors.FirstOrDefault(item => item.Color == color);
                // 如果找到原始代码，使用原始代码；否则使用默认格式
                string code = colorItem.Code != null ? colorItem.Code : $"C{SelectedColors.IndexOf(color) + 1}";
                return $"{code}\t{color}";
            }).ToList();
            File.WriteAllLines(palettePath, lines);
            
            LoadUserPalettes();
            await LoadPalette(NewPaletteName);
            SelectedColors.Clear();
            NewPaletteName = string.Empty;
            SuccessMessage = "基于选择的颜色创建调色板成功";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"创建调色板失败：{ex.Message}";
        }
    }

    private void LoadUserPalettes()
    {
        UserPalettes.Clear();
        
        // 使用跨平台兼容的应用数据目录
        string appDataDir = FileSystem.AppDataDirectory;
        string userPalettesPath = Path.Combine(appDataDir, "Data", "UserPalettes");
        
        if (Directory.Exists(userPalettesPath))
        {
            UserPalettes = Directory.GetFiles(userPalettesPath, "*.txt")
                .Select(file => Path.GetFileNameWithoutExtension(file))
                .Where(name => !string.IsNullOrEmpty(name))
                .ToList();
        }
        else
        {
            // 尝试使用应用程序基础目录（用于Windows调试）
            string baseDir = AppDomain.CurrentDomain.BaseDirectory;
            userPalettesPath = Path.Combine(baseDir, "Data", "UserPalettes");
            
            if (Directory.Exists(userPalettesPath))
            {
                UserPalettes = Directory.GetFiles(userPalettesPath, "*.txt")
                    .Select(file => Path.GetFileNameWithoutExtension(file))
                    .Where(name => !string.IsNullOrEmpty(name))
                    .ToList();
            }
        }
    }

    private async Task LoadPalette(string paletteName)
    {
        SuccessMessage = string.Empty;
        ErrorMessage = string.Empty;
        SelectedPaletteName = paletteName;
        
        try
        {
            string palettePath;
            if (paletteName == "Mard")
            {
                // 加载默认 Mard 调色板
                // 使用跨平台兼容的应用数据目录
                string appDataDir = FileSystem.AppDataDirectory;
                palettePath = Path.Combine(appDataDir, "Data", "Palettes", "Mard.txt");
                
                if (!File.Exists(palettePath))
                {
                    // 尝试使用应用程序基础目录（用于Windows调试）
                    string baseDir = AppDomain.CurrentDomain.BaseDirectory;
                    palettePath = Path.Combine(baseDir, "Data", "Palettes", "Mard.txt");
                }

                if (!File.Exists(palettePath))
                {
                    // 尝试使用当前工作目录
                    palettePath = Path.Combine(Directory.GetCurrentDirectory(), "Data", "Palettes", "Mard.txt");
                }
            }
            else
            {
                // 加载用户自定义调色板
                // 使用跨平台兼容的应用数据目录
                string appDataDir = FileSystem.AppDataDirectory;
                palettePath = Path.Combine(appDataDir, "Data", "UserPalettes", $"{paletteName}.txt");
                
                if (!File.Exists(palettePath))
                {
                    // 尝试使用应用程序基础目录（用于Windows调试）
                    string baseDir = AppDomain.CurrentDomain.BaseDirectory;
                    palettePath = Path.Combine(baseDir, "Data", "UserPalettes", $"{paletteName}.txt");
                }
            }

            if (File.Exists(palettePath))
            {
                var lines = await File.ReadAllLinesAsync(palettePath);
                PaletteColors = lines.Select(line => line.Split('\t')[1]).ToList();
            }
            else
            {
                // 如果文件不存在，使用默认颜色
                PaletteColors = new List<string> { "#FFFFFF", "#000000", "#FF0000", "#00FF00", "#0000FF" };
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"加载调色板失败：{ex.Message}";
            PaletteColors = new List<string> { "#FFFFFF", "#000000", "#FF0000", "#00FF00", "#0000FF" };
        }
    }

    private void HandleCreateNewPalette()
    {
        SuccessMessage = string.Empty;
        ErrorMessage = string.Empty;
        
        if (string.IsNullOrWhiteSpace(NewPaletteName))
        {
            ErrorMessage = "请输入调色板名称";
            return;
        }
        
        if (UserPalettes.Contains(NewPaletteName))
        {
            ErrorMessage = "该名称的调色板已存在";
            return;
        }
        
        // 创建新调色板
        SelectedPaletteName = NewPaletteName;
        // 复制当前调色板的颜色
        // 注意：这里我们不保存，用户需要手动保存
        SuccessMessage = "新调色板已创建，请编辑颜色后保存";
        NewPaletteName = string.Empty;
    }

    private async Task CreateNewPalette()
    {
        await Task.CompletedTask;
    }

    private void SavePalette()
    {
        SuccessMessage = string.Empty;
        ErrorMessage = string.Empty;
        
        if (SelectedPaletteName == "Mard")
        {
            ErrorMessage = "不能修改默认 Mard 调色板";
            return;
        }
        
        try
        {
            // 使用跨平台兼容的应用数据目录
            string appDataDir = FileSystem.AppDataDirectory;
            string userPalettesPath = Path.Combine(appDataDir, "Data", "UserPalettes");
            
            if (!Directory.Exists(userPalettesPath))
            {
                Directory.CreateDirectory(userPalettesPath);
            }
            
            var palettePath = Path.Combine(userPalettesPath, $"{SelectedPaletteName}.txt");
            var lines = PaletteColors.Select((color, index) => $"C{index + 1}\t{color}").ToList();
            File.WriteAllLines(palettePath, lines);
            
            LoadUserPalettes();
            SuccessMessage = "调色板保存成功";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"保存调色板失败：{ex.Message}";
        }
    }

    private async Task DeletePalette(string paletteName)
    {
        SuccessMessage = string.Empty;
        ErrorMessage = string.Empty;
        
        try
        {
            // 使用跨平台兼容的应用数据目录
            string appDataDir = FileSystem.AppDataDirectory;
            string userPalettesPath = Path.Combine(appDataDir, "Data", "UserPalettes");
            
            var palettePath = Path.Combine(userPalettesPath, $"{paletteName}.txt");
            
            if (!File.Exists(palettePath))
            {
                // 尝试使用应用程序基础目录（用于Windows调试）
                string baseDir = AppDomain.CurrentDomain.BaseDirectory;
                userPalettesPath = Path.Combine(baseDir, "Data", "UserPalettes");
                palettePath = Path.Combine(userPalettesPath, $"{paletteName}.txt");
            }
            
            if (File.Exists(palettePath))
            {
                File.Delete(palettePath);
                LoadUserPalettes();
                if (SelectedPaletteName == paletteName)
                {
                    await LoadPalette("Mard");
                }
                SuccessMessage = "调色板删除成功";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"删除调色板失败：{ex.Message}";
        }
    }

    private void UpdateColor(int index, string newColor)
    {
        if (index >= 0 && index < PaletteColors.Count)
        {
            PaletteColors[index] = newColor;
        }
    }

    private void AddColor()
    {
        PaletteColors.Add("#FFFFFF");
    }

    private string GetColorCode(int index)
    {
        return $"C{index + 1}";
    }

    private string GetActiveClass(string paletteName)
    {
        return SelectedPaletteName == paletteName ? "active" : "";
    }

    private string GetBoldClass(string paletteName)
    {
        return SelectedPaletteName == paletteName ? "font-weight-bold" : "";
    }

    private bool IsSelected(string paletteName)
    {
        return SelectedPaletteName == paletteName;
    }

    private async Task LoadMardPalette()
    {
        await LoadPalette("Mard");
    }

    private async Task LoadUserPalette(string paletteName)
    {
        await LoadPalette(paletteName);
    }

    private async Task DeleteUserPalette(string paletteName)
    {
        await DeletePalette(paletteName);
    }

    private string GetUserPalettesPath()
    {
        // 尝试多种路径，确保找到正确的 Data/UserPalettes 目录
        
        // 1. 从当前文件路径向上查找项目目录
        string currentFilePath = System.Reflection.Assembly.GetExecutingAssembly().Location;
        string? currentDir = Path.GetDirectoryName(currentFilePath);
        
        // 尝试从当前目录向上查找 Data 目录
        string? projectDir = currentDir;
        for (int i = 0; i < 10; i++) // 最多向上查找10层
        {
            if (projectDir != null)
            {
                string testPath = Path.Combine(projectDir, "Data", "UserPalettes");
                if (Directory.Exists(testPath))
                {
                    return testPath;
                }
                projectDir = Path.GetDirectoryName(projectDir);
            }
        }
        
        // 2. 尝试当前工作目录
        string path2 = Path.Combine(Directory.GetCurrentDirectory(), "Data", "UserPalettes");
        if (Directory.Exists(path2))
        {
            return path2;
        }
        
        // 3. 直接使用项目的固定路径
        string fixedPath = Path.Combine("d:\\Vicold\\Vicold.Pindoudou\\src\\Vicold.Pindoudou\\Vicold.Pindoudou", "Data", "UserPalettes");
        if (Directory.Exists(fixedPath))
        {
            return fixedPath;
        }
        
        // 4. 最后尝试应用程序基目录
        string path3 = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Data", "UserPalettes");
        return path3;
    }
}
