name: Build Windows Release

on:
  push:
    branches: [ "main", "action2" ]
  release:
    types: [ created ]

jobs:
  build:
    runs-on: windows-latest

    env:
      PROJECT_PATH: src/Vicold.Pindoudou/Vicold.Pindoudou/Vicold.Pindoudou.csproj
      FRAMEWORK: net10.0-windows10.0.19041.0
      RUNTIME: win-x64
      OUTPUT_DIR: publish

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    # 安装 MAUI workload（CI 必须）
    - name: Install MAUI workload
      run: dotnet workload install maui

    - name: Restore dependencies
      run: dotnet restore $env:PROJECT_PATH

    - name: Publish Windows Release
      run: |
        dotnet publish $env:PROJECT_PATH `
          -c Release `
          -f $env:FRAMEWORK `
          -r $env:RUNTIME `
          --self-contained true `
          -p:WindowsPackageType=None `
          -o $env:OUTPUT_DIR

    - name: Package as Zip
      run: |
        Compress-Archive -Path "$env:OUTPUT_DIR\*" `
                         -DestinationPath "Vicold.Pindoudou_Windows_Release.zip"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Vicold.Pindoudou-Windows-Release
        path: Vicold.Pindoudou_Windows_Release.zip

    - name: Upload to GitHub Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: Vicold.Pindoudou_Windows_Release.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}