name: Build Android Release

on:
  push:
    branches: [ "main" ]
  release:
    types: [ created ]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    env:
      PROJECT_PATH: src/Vicold.Pindoudou/Vicold.Pindoudou/Vicold.Pindoudou.csproj
      FRAMEWORK: net10.0-android
      OUTPUT_DIR: publish

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    # ⭐ MAUI 必须 install workload（restore 不够）
    - name: Install MAUI workload
      run: dotnet workload install maui

    - name: Restore dependencies
      run: dotnet restore $env:PROJECT_PATH

    # ⭐ Android 发布直接 publish 即可
    - name: Publish Android Release
      run: |
        dotnet publish $env:PROJECT_PATH `
          -c Release `
          -f $env:FRAMEWORK `
          -p:AndroidPackageFormat=apk `
          -o $env:OUTPUT_DIR

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Vicold.Pindoudou-Android-Release
        path: ${{ env.OUTPUT_DIR }}\*.apk

    - name: Upload to GitHub Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.OUTPUT_DIR }}\*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
